---
layout:     post
title:      网络安全-重放攻击
subtitle:   重放攻击
date:       2019-09-16
author:     Lij
header-img: img/post-bg-2015.jpg
catalog: true
tags:
    - 网络安全
    - 重放攻击
---
### 一、什么是重放攻击?

我们在开发接口的时候通常会考虑接口的安全性，比如说我们通常会要求请求的url携带一个经过算法加密的签名sign到服务端进行验证，如果验证通过，证明请求是合法的。比如以下的url:

http://wokao66.com/in.json?uid=7&sign=xxxxx

其中sign的常用加密算法为MD5，MD5算法是一种不可逆算法，也就是说你加密之后就不能解密了。这通常要求通讯双方约定好一个私钥appSecret，这个私钥是约定好的，不能在网络上进行传输。但单单有这个加密是远远不够的，比如说我是一名黑客，我抓包了你当前执行成功的请求信息，我们假设为request-1,既然你都执行成功了，也就是说你的这次请求的所有参数都是合法的，那么作为黑客的我，我就想能不能将你request-1的请求数据再封装成另外一个请求request-2,然后再去请求接口，如果此时系统未作任何处理，那么系统肯定是认为request-2是合法的，肯定还是会放行，但至于业务上成不成功，那么是另外一个问题了，倘若在执行业务前需要进行一个相对耗时的数据库操作，那么大量的request-2,request-3势必会使服务器瘫痪。
酱紫，可能语言难以理解，我画个图先：  
![](/img/防重放1-1.png)  

首先正常的请求系统会要求校验，当你的合法请求被黑客拦截之后，黑客就会重复地发送该合法请求，从而达到欺骗系统的目的！这种重复利用合法请求进行攻击成为重放。


### 二、如何防止重放攻击？
重放攻击的原理其实很简单，无非就是系统没有对合法请求进行唯一性校验。什么意思呢？就是说系统要知道你第一次的合法请求request-1不能被重复执行，要保证每次请求的唯一性。那么怎么去防止重放攻击呢？
#### 时间戳
**“时戳”** ──代表当前时刻的数  
**基本思想**──A接收一个消息当且仅当其包含一个对A而言足够接近当前时刻的时戳  
**原理**──重放的时戳将相对远离当前时刻  
**时钟要求**──通信各方的计算机时钟保持同步  
**处理方式**──设置大小适当的时间窗（间隔），越大越能包容网络传输延时，越小越能防重放攻击  
**适用性**──用于非连接性的对话（在连接情形下双方时钟若偶然出现不同步，则正确的信息可能会  被误判为重放信息而丢弃，而错误的重放信息可能会当作最新信息而接收）

#### 序号
通信双方通过消息中的序列号来判断消息的新鲜性  
要求通信双方必须事先协商一个初始序列号，并协商递增方法  

#### 提问与应答
**“现时”** ──与当前事件有关的一次性随机数N（互不重复即可）
**基本做法**──期望从B获得消息的A 事先发给B一个现时N，并要求B应答的消息中包含N或f(N)，f是A、B预先约定的简单函数
**原理**──A通过B回复的N或f(N)与自己发出是否一致来判定本次消息是不是重放的
时钟要求──无
**适用性**──用于连接性的对话
重放攻击是对协议的攻击中危害最大、最常见的一种攻击形式。

### 以登录为例看具体的例子
#### 常规流程
1. 前端web页面用户输入账号、密码，点击登录。
1. 请求提交之前，web端首先通过客户端脚本如javascript对密码原文进行md5加密。
1. 提交账号、md5之后的密码
1. 请求提交至后端，验证账号与密码是否与数据库中的一致，一致则认为登录成功，反之失败。

#### 有什么问题呢？
上述流程看似安全，认为传输过程中的密码是md5之后的，即使被监听截取到，由于md5的不可逆性，密码明文也不会泄露。其实不然！监听者无需解密出密码明文即可登录！监听者只需将监听到的url（如：http://****/login.do?method=login&password=md5之后的密码&userid=登录账号）重放一下，即可冒充你的身份登录系统。

#### 稍微安全点的方式
1. 进入登录页面时，生成一个随机码（称之为盐值），在客户端页面和session中各保存一份。
1. 客户端提交登录请求时，将md5之后的密码与该随机码拼接后，再次执行md5，然后提交（提交的密码=md5(md5(密码明文)+随机码)）。
1. 后端接收到登录请求后，将从数据库中查询出的密码与session中的随机码拼接后，md5运算，然后与前端传递的结果进行比较。
#### 为何要这样？
该登录方式，即使登录请求被监听到，回放登录URL，由于随机码不匹配（监听者的session中的随机码与被监听者的session中的随机码相同概率可忽略），无法登录成功。
该登录方式，由于传输的密码是原密码md5之后与随机码再次md5之后的结果，即使监听者采用暴力破解的方式，也很难解密出密码明文。

####  更进一步
考虑到密码输入的方便性，好多用户的密码都设置的很短，并且不够复杂，往往是6位数字字母组合，这样的密码md5之后保存到数据库，一旦数据库数据泄露，简单密码的md5结果很容易通过暴力破解的方式给解密出来，何况md5出现了这么多年，可能已经有不少字典了！同时为了方便用户登录的方便性，我们的系统一般不可能要求用户设置很长、很复杂的密码！怎么办？**加固定盐值**。

1. 系统设置一个固定的盐值，该盐值最好足够复杂，如:1qaz2wsx3edc4rfv!@#$%^&qqtrtRTWDFHAJBFHAGFUAHKJFHAJHFJHAJWRFA
1. 用户注册、修改密码时，将用户的原始密码与我们的固定盐值拼接，然后做md5运算。
1. 传递至后端，保存进数据库（数据库中保存的密码是用户的原始密码拼接固定盐值后，md5运算后的结果）。
1. 登录时，将用户的原始密码与我们的固定盐值进行拼接，然后做md5运算，运算后的结果再拼接上我们的随机码，再次md5运算，然后提交。
1. 后端接收到登录请求后，将从数据库中查询出的密码与session中的随机码拼接后，md5运算，然后与前端传递的结果进行比较。
#### 再再进一步
加登录验证码，可预防人为地暴力登录破解
账户锁定，如果用户密码输入错误次数达到一定量后（如6次），则可以锁定该账号
